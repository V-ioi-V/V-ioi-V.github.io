---
title: 内网穿透
tags: 计算机网络原理
category: CS大学生必备
date: 2020/05/02 16:20
---

<font size=4>

在终端敲 ifconfig -a 出来的那个ip地址就是私有ip。

百度ip地址出来的那个ip地址就是公有ip

<!--more-->

## 内网和公网

​        ABC类ip地址中，每一类都规定出一段地址用于局域网，这段ip地址是不能被互联网上的主机所路由的。也就是不能出现在互联网上，这些就是私有ip，剩下的就是可以出现在互联网上并且可以被路由到目的地的公有ip。

​        比如家庭常见的192.168.1.1就是一个私有ip，他不能出现在互联网上，如果被传到互联网上，就会被丢弃，永远不能到达目的地。

实际上我们家庭宽带中是由宽带运用商下发的一个公网ip，然后由路由器用NAT技术转换为运营商下发的那个公网ip。即便是局域网有多于一台上网终端，用的不同的私有ip，最终去到互联网之前都会被路由器NAT转换为公网ip，否则会被丢弃无法上网。

![1.jpg](https://i.loli.net/2020/05/02/8LTwBYrR2gGpnxa.jpg)

私有地址和公有地址一个是内部ip，一个是公网ip

**公网ip:**ip地址是全球唯一的，没有与你重复的ip地址，并且ip地址还具有地理位置性，个人无法获得公网ip，需要向服务商申请，申请一个少一个。其实我们每一次上网就是在与另一台服务器或电脑在进行资源共享；举个栗子，我们常登微信，你现在与你一位好友发送了一条信息，那么首先你是在给腾讯的服务器地址发送请求信息，这个请求最终通过internet网络找寻这个ip并发送过去，服务器收到请求将你发来的信息进行处理并将结果返回给你，也是通过你的ip地址。然后你的好友也是通过类似的步骤接收到这条信息 。

**内网ip:**内网ip其实和公网ip原理是一样的，只不过中间加了一些代理服务器，假设你的电脑在公司下面，那么你很有可能用的是你公司的内网，内网就是一个拥有公网的服务器通过NAT转换内网和公网ip，建立内网和公网的连接。在这个网络中拥有许多网关，公网就像是一条马路，路上有很多栋房子，你拿着它的门牌号也就是ip地址去找这栋房子，而内网就像是你找到的是一个小区，并不知道要找谁，于是你拿着门牌号给了管理人员，管理人员通过门牌号上的地址也就是端口号，找到小区里的某一间房子，然后管理人员再把信息交给你。 

内网ip是可以随便分配的，只要在这几个区间内，并且内网下没有冲突就可以用。但是还是不推荐随便分配呢，因为可以使用dhcp（动态主机配置协议），它负责帮助我们分配内网地址，不用我们手动分配了，并且不会冲突。

### 思考

**私有地址存在的意义是什么？**

 每个人都有一个公有地址不就挺好的了吗？为什么还要麻烦取一个“小名”内部地址呢？这就涉及到IPv4的网络不够用的问题了。IPv4地址随着用户的增多压力不断增大，但是每一个路由器的IP地址下面都有很多的私有地址，外部消息只需要找到这个路由器，这个路由器把消息找到真正目的主机传递给它即可。每一个路由器都可以分配很多私有地址，**并且不同路由器的私有地址可以重复**，就如同一班的“二狗子”和二班的“二狗子”并不是同一个人一样，通过这种地址转换，能够大大增加地址的容量。

### DHCP的优点

1、网络管理员可以验证IP地址和其它配置参数，而不用去检查每个主机；
2、DHCP不会同时租借相同的IP地址给两台回主机；
3、DHCP管理员可以约束特定的计算机使用特定的IP地址；
4、可以为每个DHCP作用域设置很多选项；客户机在不同子网间移动时不需要重答新设置IP地址。

## NAT协议

网络转换协议（NAT）：在私有地址和公有地址之间转换的协议。

NAT协议还有为了网络安全性的考虑。内部网络有自己安全性的考虑，这样只要保证路由器不转发内部地址的消息，那么这些消息就不会轻易跑到公网上面去，从而保证安全。

**NAT的工作**

- 数据包在内网与外网间互通时，对数据包中的源目ip进行转换
- 由内部到外部时修改源ip地址，由外部到内部时修改目标ip地址

**工作过程**

![8.png](https://i.loli.net/2020/05/02/T6HGsxA9RlYVu8B.png)

 假设一个私有地址为10.1.0.2的主机想访问互联网服务器162.105.192.12，那么首先它首先把消息发出给NAT路由器。路由器记录了它的内网地址和端口，并且给它分配一个全局地址和全局端口。这个地址关系记录在NAT路由表中。之后按照目的地址发给服务器。一段时间之后，服务器回应了请求给NAT路由器，那么路由器根据目的地址和端口（此时是全局的）按照NAT路由表转换为对应的主机地址，再发送给主机，这样主机就收到了服务器的回应。

​    从上面的过程就能看到NAT路由器的作用：针对出境包源地址进行替换；在NAT转换表中记录映射关系；针对入境包目标地址进行替换。NAT的路由表如下所示：

![9.png](https://i.loli.net/2020/05/02/o7j8nhVKT6NzLHq.png)

## 内网穿透

### 概念

内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就是说映射端口，能让外网的电脑找到处于内网的电脑，提高下载速度。不管是内网穿透还是其他类型的网络穿透，都是网络穿透的统一方法来研究和解决。

### 原因

网络地址转换（Network Address Translation，NAT）机制的问题在于，**NAT设备自动屏蔽了非内网主机主动发起的连接**，(因为出于安全起见，除非是主机主动向对方发出了连接请求（这时会在该主机的数据结构中留下一条记录），否则，当主机接收到数据包时，如果在其数据结构中查询不到对应的记录，那些不请自来的数据包将会被丢弃。)也就是说，从外网发往内网的数据包将被NAT设备丢弃，这使得位于不同NAT设备之后的主机之间无法直接交换信息。这一方面保护了内网主机免于来自外部网络的攻击，另一方面也为P2P通信带来了一定困难。

