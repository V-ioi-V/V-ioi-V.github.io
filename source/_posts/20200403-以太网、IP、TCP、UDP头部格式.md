---
title: 以太网、IP、TCP、UDP头部格式
tags: 计算机网络原理
category: CS大学生必备
date: 2020/04/03/ 22:41
---

<font size=4>

## 以太网帧的格式

![6.png](https://i.loli.net/2020/04/03/o4rU1WO9PNEGKHa.png)

（1）其中的源地址和目的地址是指网卡的硬件地址（也叫MAC 地址），长度是48 位(6个字节)，是在网卡出厂时固化的。

（2）注意网卡芯片（例如DM9000A）收到的数据就是如上所示的一长串数据；其中包括以太网帧头、IP报报头、传输层协议段头、应用层所需数据。

（3）以太网帧中的数据长度规定最小46 字节，最大1500 字节，ARP 和RARP 数据包的长度不够46 字节，要在后面补填充位。最大值1500 称为以太网的最大传输单元（MTU），不同的网络类型有不同的MTU，如果一个数据包从以太网路由到拨号链路上，数据包度大于拨号链路的MTU了，则需要对数据包进行分片fragmentation）。ifconfig 命令的输出中也有“MTU:1500”。**MTU是指数据帧中有效载荷的最大长度，不包括帧首部的长度。**

## IP报头格式

　　IP是TCP/IP协议簇中最为重要的协议。所有的TCP、UDP、 ICMP和IGMP数据都以IP数据报格式传输。IP提供的是不可靠、无连接的协议。

![5.png](https://i.loli.net/2020/04/03/cDwF3V1BSv4uCWq.png)


普通的IP首部长为20个字节，除非含有选项字段。

**4位版本：**目前协议版本号是4，因此IP有时也称作IPV4.

**4位首部长度：**首部长度指的是首部占32bit字的数目，包括任何选项。由于它是一个4比特字段，最大表示15行，一行4个字节32位，因此首部长度最长为60个字节。

**服务类型（TOS）：**服务类型字段包括一个3bit的优先权字段（现在已经被忽略），4bit的TOS子字段和1bit未用位必须置0。4bit的TOS分别代表：最小时延，最大吞吐量，最高可靠性和最小费用。4bit中只能置其中1比特。如果所有4bit均为0，那么就意味着是一般服务。

**总长度：**总长度字段是指整个IP数据报的长度，以字节为单位。利用首部长度和总长度字段，就可以知道IP数据报中数据内容的起始位置和长度。由于该字段长16bit，所以IP数据报最长可达65535字节。当数据报被分片时，该字段的值也随着变化。

**标识字段：**标识字段唯一地标识主机发送的每一份数据报。**如果分片的话每一片的标示字段都是一样的，便于目的主机把这些分片给组装起来**，通常每发送一个数据包它的值就会加1。

**3位标志：**

- CU(没啥用)：0
- DF（delete fragment）：1表示如果我这个包大于你的MTU，不要分片，直接丢掉，并且通过ICMP告诉我你的MTU。（后续发包会根据这个MTU调小）。
- MF（more fragment）：1表示我这一片不是最后一片，后面还有分片。0表示我就是最后一片，后面没有分片了。

**片偏移量：**按顺序搞的，比如第一个片是0，第二个片的要用第一个片的片偏移加上第一个片的长度，为的是在目的主机把片按顺序串在一起。

**生存时间：**TTL（time-to-live）生存时间字段设置**了数据报可以经过的最多路由器数**。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为 32或6 4），一旦经过一个处理它的路由器，它的值就减去 1。当该字段的值为 0时，数据报就被丢弃，并发送 ICMP报文通知源主机。**（防止网络出现环路）。**

**协议：**8位，这个字段定义了IP数据报的数据部分使用的协议类型,常见的如下：

-  1    ICMP
-  2    IGMP
-  6    TCP
-  17  UDP
-  88  IGRP
-  89  OSPF

**首部检验和：**校验看原长度和传过来的长度是否一致，首部检验和字段是根据 I P首部计算的检验和码。它不对首部后面的数据进行计算。 I C M P、I G M P、U D P和T C P在它们各自的首部中均含有同时覆盖首部和数据检验和码。

## TCP首部格式

　　尽管TCP和UDP都使用相同的网络层（ I P），T C P却向应用层提供与U D P完全不同的服务。T C P提供一种面向连接的、可靠的字节流服务。

　　如果不计任选字段，它通常是 2 0个字节。

![3.jpeg](https://i.loli.net/2020/04/03/XoIRQwPr392GDSx.jpg)

**源端口号和目的端口号：**用于寻找发送端和接收端应用进程。这两个值加上IP首部中的源端IP地址和目的端IP地址唯一确定一个TCP连接。(源端口号是临时端口号，是随机的，一般大于1024。目的端口号是固定的)

**序号字段：**序号用来标识从TCP发送端向TCP接收端发送的数据字节流，它**表示在这个报文段中的的第一个数据字节**。如果将字节流看作在两个应用程序间的单向流动，则 TCP用序号对每个字节进行计数。序号是32 bit的无符号数，序号到达 2^32-1后又从0开始。

当建立一个新的连接时，SYN标志变1。序号字段包含由这个主机选择的该连接的初始序号ISN（Initial Sequence Number）。该主机要发送数据的第一个字节序号为这个ISN加1，因为SYN标志消耗了一个序号（FIN标志也要占用一个序号）

**确认序号：**既然每个传输的字节都被计数，确认序号包含**发送确认的一端所期望收到的下一个序号**。因此，确认序号应当是上次已成功收到数据字节序号加 1。只有ACK标志（下面介绍）为 1时确认序号字段才有效。发送ACK无需任何代价，因为 32 bit的确认序号字段和ACK标志一样，总是TCP首部的一部分。因此，我们看到一旦一个连接建立起来，这个字段总是被设置， ACK标志也总是被设置为1。TCP为应用层提供全双工服务。这意味数据能在两个方向上独立地进行传输。因此，连接的每一端必须保持每个方向上的传输数据序号。**每次发送的数据字段的序号是从确认序号开始往下编号的。**

**首部长度：**首部长度给出首部中 32 bit字的数目。需要这个值是因为任选字段的长度是可变的。这个字段占4 bit，因此T C P最多有6 0字节的首部。然而，没有任选字段，正常的长度是 2 0字节。

**标志字段：**在T C P首部中有 6个标志比特。它们中的多个可同时被设置为1.

- URG紧急指针（urgent pointer）有效。
- ACK确认序号有效。
- PSH接收方应该尽快将这个报文段交给应用层。
- RST重建连接。
- SYN同步序号用来发起一个连接。。
- FIN发端完成发送任务。

**窗口大小：**TCP的流量控制由连接的每一端通过声明的窗口大小来提供。窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节。窗口大小是一个 16 bit字段，因而窗口大小最大为 65535字节。

**检验和：**检验和覆盖了整个的 TCP报文段：TCP首部和TCP数据。这是一个强制性的字段，一定是由发端计算和存储，并由收端进行验证。

**紧急指针：**只有当URG标志置1时紧急指针才有效。紧急指针是一个正的偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号。 T C P的紧急方式是发送端向另一端发送紧急数据的一种方式。

**选项：**最常见的可选字段是最长报文大小，又称为 MSS (Maximum Segment Size)。每个连接方通常都在通信的第一个报文段（为建立连接而设置 S Y N标志的那个段）中指明这个选项。它指明本端所能接收的最大长度的报文段。

## UDP首部

UDP是一个简单的面向数据报的运输层协议：进程的每个输出操作都正好产生一个UDP数据报，并组装成一份待发送的 I P数据报。这与面向流字符的协议不同，如 T C P，应用程序产生的全体数据与真正发送的单个 I P数据报可能没有什么联系。

![download.jpeg](https://i.loli.net/2020/04/03/HAyzpmasobgUZwc.jpg)

**端口号：**用来表示发送和接受进程。由于 IP层已经把IP数据报分配给TCP或UDP（根据IP首部中协议字段值），因此TCP端口号由TCP来查看，而 UDP端口号由UDP来查看。TCP端口号与UDP端口号是相互独立的。

**长度：**UDP长度字段指的是UDP首部和UDP数据的字节长度。该字段的最小值为 8字节（发送一份0字节的UDP数据报是 0K）。

**检验和：**UDP检验和是一个端到端的检验和。它由发送端计算，然后由接收端验证。其目的是为了发现UDP首部和数据在发送端到接收端之间发生的任何改动。