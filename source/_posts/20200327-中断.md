---
title: 中断
tags: 操作系统
category: CS大学生必备
date: 2020/03/27
---

操作系统内核的一种支撑功能

<!--more-->

<font size=4>

# 中断的定义

 中断是**改变处理器执行指令顺序的一种事件。这样的事件与CPU芯片内外部硬件电路产生的电信号相对应 。**(中断本质上是一种电信号，导致程序流走向发生改变)

计算机在执行程序的过程中，当出现中断时，计算机停止现行程序的运行，转向对这些中断事件的处理，处理结束后再返回到现行程序的间断处。**引入中断机制能有效提高CPU的利用率，改善系统性能。**

# 为什么要引入中断

- CPU可以与其它设备并行工作，能有效提高CPU的利用率，改善系统性能，支持系统的异步性

引入中断机制之前，CPU只能采用一个个寻找的方式，严重浪费资源

# 中断的类型

## 内部中断（同步中断或异常）

出发出错，调试，溢出，浮点错误，缺页

## 外部中断（异步中断）

- 外部可屏蔽中断（I/O设备产生的中断）
- 外部不可屏蔽中断（紧急事件引起的中断,如硬件故障）

### 中断屏蔽

​       一个屏蔽的中断只要还是屏蔽的，控制单元就忽略它。当eflags寄存器的IF标志被清0时，由PIC发布的每个可屏蔽中断都由CPU暂时忽略。置1时，CPU可以执行中断。

#### linux里屏蔽中断

​      Linux中用cli和sti汇编指令分别清除和设置该标志。cli用来清0IF标志位，sti用来置1（这两个指令为特权指令，只能由操作系统内核执行）

#### 思考:中断被屏蔽以后，CPU为什么不能转去执行其他进程？

中断被屏蔽以后，CPU无法收到中断信号，无法触发暂停当前进程的信号，CPU无法暂停执行当前指令转去执行其他进程。

# 引起中断的原理

- 人为设置中断：在程序中人为设置中断。
- 程序性事故：计算中出现除数为0。
- 硬件故障：插件接触不良、电源掉电等。
- I/O设备：I/O设备被启动以后，一旦其准备就绪，便向CPU发出中断请求。
- 外部事件：如用户通过键盘来中断现行程序 

# 中断响应

- 响应中断的**条件**： 开中断
- 响应外部中断的**时机**：  CPU每执行完一条指令
- 内部中断：随时可能产生

# 单重中断的执行

![Picture1.png](https://i.loli.net/2020/03/27/vTfXwuUIe43S9tA.png)

*注：现在的计算机系统大多允许中断嵌套，在这样的系统中，在保护完现场后就可以打开中断，允许响应新的中断*

保护现场：保存硬件上下文

**为什么操作系统无法把PC的值保存到内存中去的？**

PC存的是程序的指令的值，PC的值已经被覆盖了，已经是操作系统内核代码指令的地址，而不是刚才被中断信号暂停时指令的地址。

# 如何找到中断服务子程序

- 不同中断源对应不同的**中断向量**
- 根据中断向量查找中断向量表
- 从中断向量表中的表项中读取中断处理子程序的入口地址相关信息

## 中断向量与中断向量表

![Picture3.png](https://i.loli.net/2020/03/27/rFmjyqv3xk2D7OC.png)

idtr:CPU上的一个寄存器，存放中断向量表的起始地址

中断向量表表向长度是固定的

## 如何计算存在中断向量表里中断子程序入口地址在内存的地址

idtr+中断向量表表向的长度×中断向量的值

# 关于中断

## OS需要做的事情

- 初始化中断向量表
- 初始化中断向量表寄存器
- 执行中断处理程序
- 执行中断服务子程序

## 硬件需要做的事情

- 不同中断源对应的中断向量值
- 可编程中断控制器接口
- 与中断相关的寄存器名称及其用途