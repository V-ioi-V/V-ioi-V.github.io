---
title: HTTP劫持和DNS劫持
tags: 计算机网络原理
category: CS大学生必备
date: 2020/05/02 15:50
---

   简单介绍一下HTTP劫持和DNS劫持的概念，也就是运营商通过某些方式篡改了用户正常访问的网页，插入广告或者其他一些杂七杂八的东西。

<!--more-->

<font size=4>

  **在具体的做法上，一般分为DNS劫持和HTTP劫持。**

  ## DNS劫持

​      一般而言，用户上网的DNS服务器都是运营商分配的，所以，在这个节点上，运营商可以为所欲为。

​     例如，访问http:/ /jiankang.qq.com/index.html，正常DNS应该返回腾讯的ip，而DNS劫持后，会返回一个运营商的中间服务器ip。访问该服务器会一致性的返回302，让用户浏览器跳转到预处理好的带广告的网页，在该网页中再通过iframe打开用户原来访问的地址。

 ## HTTP劫持

​      在运营商的路由器节点上，设置协议检测，一旦发现是HTTP请求，而且是html类型请求，则拦截处理。后续做法往往分为2种，1种是类似DNS劫持返回302让用户浏览器跳转到另外的地址，还有1种是在服务器返回的HTML数据中插入js或dom节点（广告）。

 **在用户角度，这些劫持的表现分为：**

  1、网址被无辜跳转，多了推广尾巴；

  2、页面出现额外的广告（iframe模式或者直接同页面插入了dom节点）。

## 处理办法

  1、先对外网做检测，上报被劫持的情况。

​      对于我这个业务而言，加推广尾巴没意义，那么就剩下植入广告的问题了。页面广告可能通过iframe方式，也可以通过dom节点方式，需要在首页检查这两种情况。

（注：事后发现这个url检查不够严谨，虽然劫持的情况都能发现，但也把产品原有的一些正常插入做劫持误报了。例如"http:/ /jiankang.qq.com" data-id="1"，不过这个是小细节，把正则表达式完善一下就ok了)

  2、针对被iframe加载的情况，需要先找到运营商设置的劫持规律。

​      在iframe中的网页能正常打开，而不是又被拦截加iframe，可能是因为请求的url上或cookie上运营商做了标记。我们可以利用这个规则，躲过劫持。

  3、针对注入dom节点的情况，初始化时做检查，而且后续dom注入也做检查。可以检查dom中是否含有白名单以外的http链接，如果有，就可以判定为http劫持。

  4、在前端以外的处理办法还有

- a) 终端拦截所有返回包，判断ip来自黑名单（劫持的中间ip）则丢弃返回包。

​        这种做法的原因是，运营商劫持http请求后，并不是完全丢弃请求包，而是做了复制，一份继续发给目标服务器，另外一份做劫持处理直接返回302。因为这个302会比目标服务器的正常返回早得多，所以用户浏览器会只认第一个302，而丢弃后到的正常返回。

​        如果先把第一个302丢弃，等待后续正常返回，则问题解决。

- b) 终端拦截请求包，并拆包发送。

​        运营商一般判断是否劫持，通过判断是否HTTP请求。 一般只会检测TCP连接建立后的第一个数据包，如果其是一个完整的HTTP协议才会被标记；如果并非是一个完整的HTTP协议，由于无法得到足够多的劫持信息，所以并不会被标记为HTTP协议。 

​        所以，只要把请求包切得足够细，就能躲过一部分劫持（如果运营商学习“墙”大力气做多包拦截就没辙了）。

  5、当然，最终，根本解决办法是使用HTTPS，不过这个涉及到很多业务的修改，成本较高。如果劫持比例小，也许通过适当的补救做法会更好。

 