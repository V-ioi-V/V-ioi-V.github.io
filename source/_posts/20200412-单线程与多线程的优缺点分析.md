---
title: 单线程与多线程的优缺点分析
tags: 操作系统
category: CS大学生必备 
date: 2020/04/12 11:14
---

<font size=4>

## 思考

**多线程一定能提高CPU利用率吗？**

CPU运行时，将运行时间分片，通过调度来分配给各个进程线程来执行。因为时间片非常短，所以常常让人误以为是多个线程是同时并行执行。

使用多线程来提高程序处理速度，其本质是提高对CPU的利用率。主要是两个方面

- 阻塞等待时充分利用CPU
  当程序发生阻塞的操作时候，例如IO等待，CPU将就空闲下来了。而使用多线程，当一些线程发生阻塞的时候，另一些线程则仍能利用CPU，而不至于让CPU一直空闲。
- 利用CPU的多核并行计算能力
   现在的CPU基本上都是多核的。使用多线程，可以利用多核同时执行多个线程，而不至于单线程时一个核心满载，而其他核心空闲。

多线程就一定能提高处理速度吗？是不一定。当程序偏计算型的时候，盲目启动大量线程来并发，并不能提高处理速度，反而会降低处理速度。因为在多个线程进行切换执行的时候会带会一定的开销。其中有 上下文切换开销，CPU调度线程的开销，线程创建和消亡的开销等。其中主要是上下文切换带来的开销。

上下文切换的开销，主要是来自于当线程切换时保存上一个线程现场和载入下一个线程现场的操作。

## 多线程：

　　同步应用程序的开发比较容易，但由于需要在上一个任务完成后才能开始新的任务，所以其效率通常比多线程应用程序低。如果完成同步任务所用的时间比预计时间长，应用程序可能会不响应。多线程处理可以同时运行多个过程。

　　例如：文字处理器应用程序在您处理文档的同时，可以检查拼写（作为单独的任务）。由于多线程应用程序将程序划分成独立的任务，因此可以在以下方面显著提高性能：

- 多线程技术使程序的响应速度更快，因为用户界面可以在进行其他工作的同时一直处于活动状态。

- 当前没有进行处理的任务可以将处理器时间让给其他任务。

- 占用大量处理时间的任务可以定期将处理器时间让给其他任务。

- 可以随时停止任务。

- 可以分别设置各个任务的优先级以优化性能。

是否需要创建多线程应用程序取决于多个因素。在以下情况下，最适合采用多线程处理：

- 耗时或大量占用处理器的任务阻塞用户界面操作。

- 各个任务必须等待外部资源（如远程文件或 INTERNET 连接）。

　　例如：用于跟踪 WEB 页上的链接并下载满足特定条件的文件的 INTERNET 应用程序“ROBOT”。这种应用程序可以依次同步下载各个文件，也可以使用多线程同时下载多个文件。多线程方法比同步方法的效率高很多，因为即使在某些线程中远程 WEB 服务器的响应非常慢，也可以下载文件。

**坏处：**增加了调度和管理的开销，带来了一些不确定性，需要复杂的同步机制，避免死锁等等。

**好处：**一定程度上提高响应速度，在多核的情况下还是更能充分利用CPU资源的。

### 线程的切换

多线程的切换需要保存线程的上下文

线程切换时需要知道在这之前当前线程已经执行到哪条指令了，所以需要记录程序计数器的值，另外比如说线程正在进行某个计算的时候被挂起了，那么下次继续执行的时候需要知道之前挂起时变量的值时多少，因此需要记录CPU寄存器的状态。所以一般来说，线程上下文切换过程中会记录**程序计数器(PC)、堆栈指针（SP,指向当前栈的栈顶地址）、CPU寄存器状态**等数据。

### 进程的切换

CPU的所有寄存器中的值、进程的状态以及堆栈上的内容。

## 单线程：

　　单线程的也就是程序执行时，所跑的程序路径（处理的东西）是连续顺序下来的，必须前面的处理好，后面的才会执行到。

　　由于时间片很短，这样给用户的感觉是同时有好多线程在执行。但是线程切换是有代价的，因此如果采用多进程，那么就需要将线程所隶属的该进程所需要的内存进行切换，这时间代价是很多的。而线程切换代价就很少，线程是可以共享内存的。所以采用多线程在切换上花费的比多进程少得多。但是，线程切换还是需要时间消耗的，所以采用一个拥有两个线程的进程执行所需要的时间比一个线程的进程执行两次所需要的时间要多一些。即采用多线程不会提高程序的执行速度，反而会降低速度，但是对于用户来说，可以减少用户的响应时间。上述结果只是针对单CPU，如果对于多CPU或者CPU采用超线程技术的话，采用多线程技术还是会提高程序的执行速度的。因为单线程只会映射到一个CPU上，而多线程会映射到多个CPU上，超线程技术本质是多线程硬件化，所以也会加快程序的执行速度。

线程相对于进程的优点：

1、开销小

2、资源共享性好。

线程相对于进程的缺点：

1、共享资源需要耗费一定的锁资源，同步相对复杂。

2、一个线程崩溃可能导致整个进程崩溃，这个当然是自己的应用程序有问题