---
title: 进程和线程间的通信方式
tags: 操作系统
category: CS大学生必备
date: 2020/05/5 16:37
---

进程间通信（IPC，Inter-Process Communication）是指在不同进程之间传播或交换信息.

IPC的方式通常有管道（包括无名管道和命名管道）、消息队列、信号量、共享存储、Socket、Streams等。其中 Socket和Streams支持不同主机上的两个进程IPC。

<!--more-->

<font size=4>

# 进程间的通信

## 概念

进程用户空间是相互独立的，一般而言是不能相互访问的。但很多情况下进程间需要互相通信，来完成系统的某项功能。进程通过与内核及其它进程之间的互相通信来协调它们的行为。

## 应用场景

- 数据传输：一个进程需要将它的数据发送给另一个进程，发送的数据量在一个字节到几兆字节之间。
- 共享数据：多个进程想要操作共享数据，一个进程对共享数据的修改，别的进程应该立刻看到。
- 通知事件：一个进程需要向另一个或一组进程发送消息，通知它（它们）发生了某种事件（如进程终止时要通知父进程）。
- 资源共享：多个进程之间共享同样的资源。为了作到这一点，需要内核提供锁和同步机制。
- 进程控制：有些进程希望完全控制另一个进程的执行（如Debug进程），此时控制进程希望能够拦截另一个进程的所有陷入和异常，并能够及时知道它的状态改变。

## 一、管道

管道，通常指无名管道。是由内核管理的一个缓冲区，相当于我们放入内存中的一个纸条。管道的一端连接一个进程的输出。这个进程会向管道中放入信息。管道的另一端连接一个进程的输入，这个进程取出被放入管道的信息。一个缓冲区不需要很大，它被设计成为环形的数据结构，以便管道可以被循环利用。当管道中没有信息的话，从管道中读取的进程会**等待**，直到另一端的进程放入信息。当管道被放满信息的时候，尝试放入信息的进程会**等待**，直到另一端的进程取出信息。当两个进程都终结的时候，管道也自动消失。

![2.jpg](https://i.loli.net/2020/05/05/VzDa5q96cWLFxtN.jpg)

### 特点：
它是半双工的（即数据只能在一个方向上流动），具有固定的读端和写端。

它只能用于具有亲缘关系的进程之间的通信（也是父子进程或者兄弟进程之间）。

（父子进程或者兄弟进程指的是fork或者vfork创建的进程）

- **fork()创建的子进程拥有了自己的栈和数据段拷贝，而且，在子进程中对父进程变量的修改，不会影响父进程；**

- **vfork()创建的子进程共享父进程的内存，所以在子进程中对父进程变量的修改，会影响父进程。**

它可以看成是一种特殊的文件，对于它的读写也可以使用普通的read、write 等函数。但是它不是普通的文件，并不属于其他任何文件系统，并且只存在于内存中。

管道是一个固定大小的缓冲区。在Linux中，该缓冲区的大小为1页，即4KB，使得它的大小不象文件那样不加检验地增长。从管道读数据是一次性操作，数据一旦被读，它就从管道中被抛弃。

## 二、FIFO

FIFO，也称为命名管道，它是一种文件类型。

### 特点

FIFO可以在无关的进程之间交换数据，与无名管道不同。

FIFO有路径名与之相关联，它以一种特殊设备文件形式存在于文件系统中。

## 三、消息队列

消息队列，是消息的链接表，存放在内核中。一个消息队列由一个标识符（即队列ID）来标识。

### 特点

消息队列是面向记录的，其中的消息具有特定的格式以及特定的优先级。

消息队列独立于发送与接收进程。进程终止时，消息队列及其内容并不会被删除。

消息队列可以实现消息的随机查询,消息不一定要以先进先出的次序读取,也可以按消息的类型读取。

## 四、信号量

信号量（semaphore）与已经介绍过的 IPC 结构不同，它是一个计数器。信号量用于实现进程间的互斥与同步，而不是用于存储进程间通信数据。

信号量是一个计数器，可以用来控制多个进程对共享资源的访问。它通常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段。

### 特点

信号量用于进程间同步，若要在进程间传递数据需要结合共享内存。

信号量基于操作系统的 PV 操作，程序对信号量的操作都是原子操作。

每次对信号量的 PV 操作不仅限于对信号量值加 1 或减 1，而且可以加减任意正整数。

支持信号量组。

## 五、共享内存

共享内存（Shared Memory），指两个或多个进程共享一个给定的存储区。

### 特点

共享内存是最快的一种 IPC，因为进程是直接对内存进行存取。

因为多个进程可以同时操作，所以需要进行同步。

信号量+共享内存通常结合在一起使用，信号量用来同步对共享内存的访问。



# 线程间的通信

同一进程的线程之间使用共享变量就可以通信

## 为什么要线程同步

线程间的通信主要是为了线程的同步。

当多个线程**同时读写同一份共享资源的时候**，可能会引起冲突。这时候，我们需要引入线程“同步”机制，即各个线程之间要有先来后到，不能一窝蜂同时挤上去抢作一团。

线程同步其实就是相对于现实中的“排队”,几个线程之间要排队，一个一个对共享资源进行操作，而不是同时进行操作。

**线程同步是为了防止多个线程同时访问同一个数据对象时，对数据造成破坏。**

**线程的同步是保证多线程安全访问资源的一种手段。**

1、**锁机制**

- **自旋锁：**只要没有锁上，就不断的重试，不断对资源发出申请。

- **互斥锁：**提供了以排它方式阻止数据结构被并发修改的方法。
- **条件变量：**可以以原子的方式阻塞进程，直到某个特定条件为真为止。对条件测试是在互斥锁的保护下进行的。条件变量始终与互斥锁一起使用。

- **读写锁：**允许多个线程同时读共享数据，而对写操作互斥。

2、**信号量机制**：允许多个线程同时访问公共资源。当时控制了访问资源的线程的最大个数。

3、**信号机制**：类似于进程间的信号处理。

4、**临界区：**任意时刻只能有一个线程进入临界区，访问临界资源。

**死锁条件：互斥、不可剥夺、循环等待、请求与保持。**

## 互斥量和临界区的区别

- 两者都可以实现对互斥资源的互斥访问
- 临界区只能用于对象在同一进程里线程间的互斥访问；互斥体可以用于对象进程间或线程间的互斥访问。
- 临界区是非内核对象，只在用户态进行锁操作，速度快；互斥体是内核对象，在核心态进行锁操作，速度慢。
- 临界区和互斥体在Windows平台都下可用；Linux下只有互斥体可用。

详细见：https://www.cnblogs.com/WindSun/p/11441234.html